<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Nostr Badges Viewer</title>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
    h2 { margin-top: 20px; }
    .profile {
      background: white; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    .badges { display: flex; flex-wrap: wrap; gap: 10px; }
    .badge {
      background: white; border: 1px solid #ccc;
      padding: 10px; border-radius: 6px;
      text-align: center; width: 140px;
    }
    .badge img { max-width: 80px; display: block; margin: 0 auto 5px; }
    .mini-badges img { width: 32px; height: 32px; margin-right: 5px; }
  </style>
</head>
<body>
  <h1>Nostr NIP-56 Badges Viewer</h1>
  <input id="npubInput" placeholder="対象のnpub" size="66">
  <button onclick="loadFromNpub()">Load</button>
  <button onclick="loginWithNostr()">Nostr Login</button>

  <div id="profile" class="profile"></div>

  <h2>受け取ったバッジ一覧</h2>
  <div id="received" class="badges"></div>

  <h2>発行したバッジ一覧</h2>
  <div id="issued" class="badges"></div>

  <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
  <script>
    // 複数リレー
    const relayUrls = [
  "wss://relay.damus.io",
  "wss://nos.lol",
  "wss://relay.nostr.band",
  "wss://relay.snort.social",
  "wss://relay.nostrcheck.me",
  "wss://relay-jp.nostr.wirednet.jp",
  "wss://yabu.me",
  "wss://r.kojira.io
    ];
    let sockets = [];
    let currentPubkeyHex = "";

    function connectRelays() {
      relayUrls.forEach(url => {
        const socket = new WebSocket(url);
        sockets.push(socket);

        socket.onopen = () => console.log("Relay connected:", url);
        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data[0] === "EVENT") handleEvent(data[2]);
        };
      });
    }

    function sendToAllRelays(message) {
      sockets.forEach(s => {
        if (s.readyState === WebSocket.OPEN) {
          s.send(JSON.stringify(message));
        }
      });
    }

    async function loginWithNostr() {
      if (!window.nostr) {
        alert("Nostr Login対応拡張が見つかりません");
        return;
      }
      try {
        const pubkey = await window.nostr.getPublicKey();
        currentPubkeyHex = pubkey;
        loadAll(pubkey);
      } catch (e) {
        console.error(e);
        alert("Nostr Login失敗");
      }
    }

    function loadFromNpub() {
      const npub = document.getElementById("npubInput").value.trim();
      if (!npub) return alert("npubを入力してください");
      try {
        const {type, data} = NostrTools.nip19.decode(npub);
        if (type !== "npub") throw new Error("npub形式ではありません");
        currentPubkeyHex = data;
        loadAll(currentPubkeyHex);
      } catch (e) {
        console.error(e);
        alert("npubのデコードに失敗しました");
      }
    }

    function loadAll(pubkeyHex) {
      document.getElementById("profile").innerHTML = "";
      document.getElementById("received").innerHTML = "";
      document.getElementById("issued").innerHTML = "";

      // プロフィール
      sendToAllRelays(["REQ","profile",{kinds:[0],authors:[pubkeyHex]}]);

      // 受け取ったバッジ
      sendToAllRelays(["REQ","received",{kinds:[8],"#p":[pubkeyHex]}]);

      // 発行したバッジ定義
      sendToAllRelays(["REQ","issued",{kinds:[30008],authors:[pubkeyHex]}]);
    }

    function handleEvent(event) {
      if (event.kind === 0) {
        const c = JSON.parse(event.content);
        document.getElementById("profile").innerHTML = `
          <strong>Name:</strong> ${c.name||""}<br>
          <strong>About:</strong> ${c.about||""}<br>
          <img src="${c.picture||""}" width="100"><br>
          <div class="mini-badges" id="profileBadges"></div>
        `;
      }

      if (event.kind === 8) {
        const aTag = event.tags.find(t=>t[0]==="a");
        if (aTag) {
          const parts = aTag[1].split(":");
          if (parts.length===3 && parts[0]==="30008") {
            const issuer = parts[1];
            const identifier = parts[2];
            sendToAllRelays([
              "REQ", `def-${issuer}-${identifier}`,
              {kinds:[30008],authors:[issuer],"#d":[identifier]}
            ]);
          }
        }
      }

      if (event.kind === 30008) {
        const id = event.tags.find(t=>t[0]==="d")?.[1];
        const name = event.tags.find(t=>t[0]==="name")?.[1] || "Unnamed";
        const desc = event.tags.find(t=>t[0]==="description")?.[1] || "";
        const img  = event.tags.find(t=>t[0]==="image")?.[1] || "";

        renderBadge(event.pubkey, id, name, desc, img);
      }
    }

    function renderBadge(issuer, id, name, desc, img) {
      const div=document.createElement("div");
      div.className="badge";
      div.innerHTML=`<img src="${img}"><div><strong>${name}</strong></div><div>${desc}</div>`;
      if (issuer===currentPubkeyHex) {
        document.getElementById("issued").appendChild(div);
      } else {
        document.getElementById("received").appendChild(div);
        // プロフィールにも小さいアイコンを追加
        const mini=document.createElement("img");
        mini.src=img;
        document.getElementById("profileBadges")?.appendChild(mini);
      }
    }
<style>
  /* 追加: モーダル */
  .modal {
    display: none;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center; align-items: center;
  }
  .modal-content {
    background: white; padding: 20px; border-radius: 10px;
    max-width: 400px; text-align: center;
  }
  .modal-content img { max-width: 200px; margin-bottom: 10px; }
</style>

<div id="badgeModal" class="modal" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <img id="modalImg">
    <h3 id="modalName"></h3>
    <p id="modalDesc"></p>
    <button onclick="closeModal()">閉じる</button>
  </div>
</div>

<script>
  function renderBadge(issuer, id, name, desc, img) {
    const div=document.createElement("div");
    div.className="badge";
    div.innerHTML=`<img src="${img}"><div><strong>${name}</strong></div><div>${desc}</div>`;
    if (issuer===currentPubkeyHex) {
      document.getElementById("issued").appendChild(div);
    } else {
      document.getElementById("received").appendChild(div);
      // プロフィールにも小さいアイコンを追加（クリックでモーダル）
      const mini=document.createElement("img");
      mini.src=img;
      mini.style.cursor="pointer";
      mini.onclick=()=>openModal(img, name, desc);
      document.getElementById("profileBadges")?.appendChild(mini);
    }
  }

  function openModal(img, name, desc) {
    document.getElementById("modalImg").src = img;
    document.getElementById("modalName").textContent = name;
    document.getElementById("modalDesc").textContent = desc;
    document.getElementById("badgeModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("badgeModal").style.display = "none";
  }
</script>


    connectRelays();
  </script>
</body>
</html>
