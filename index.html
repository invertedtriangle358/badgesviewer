<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Nostr Badges Viewer (Final Fix)</title>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <style>
        /* --- スタイル定義 (省略、変更なし) --- */
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
        h1, h2 { color: #333; }
        h2 { margin-top: 20px; }
        #npubInput { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; margin-left: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        
        .profile {
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        .profile img { border-radius: 50%; margin-right: 15px; }
        .profile-header { display: flex; align-items: center; }

        .badges { display: flex; flex-wrap: wrap; gap: 15px; }
        .badge {
            background: white; border: 1px solid #ddd;
            padding: 15px; border-radius: 8px;
            text-align: center; width: 160px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .badge:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .badge-image { max-width: 100px; max-height: 100px; object-fit: contain; display: block; margin: 0 auto 10px; }
        .mini-badges { margin-top: 10px; }
        .mini-badges img { width: 32px; height: 32px; margin-right: 5px; border-radius: 4px; cursor: pointer; }

        /* モーダル */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px;
            max-width: 90%; width: 400px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content img { max-width: 100%; height: auto; border-radius: 6px; margin-bottom: 15px; }
        .modal-content h3 { margin-top: 0; }
        .modal-content button { margin-top: 15px; background-color: #6c757d; }
    </style>
</head>
<body>
    <h1>Nostr NIP-56 Badges Viewer</h1>
    <div>
        <input id="npubInput" placeholder="対象のnpubを入力してください" size="60">
        <button id="loadButton">Load</button>
        <button id="nostrLoginButton">Nostr Login</button>
    </div>

    <div id="profile" class="profile"></div>

    <h2>受け取ったバッジ一覧</h2>
    <div id="receivedBadges" class="badges"></div>

    <h2>発行したバッジ一覧</h2>
    <div id="issuedBadges" class="badges"></div>

    <div id="badgeModal" class="modal" onclick="NostrApp.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalImg" class="badge-image">
            <h3 id="modalName"></h3>
            <p id="modalDesc"></p>
            <button onclick="NostrApp.closeModal()">閉じる</button>
        </div>
    </div>

    <script>
        const DOM_IDS = {
            INPUT: "npubInput",
            PROFILE: "profile",
            RECEIVED: "receivedBadges",
            ISSUED: "issuedBadges",
            MODAL: "badgeModal",
            MODAL_IMG: "modalImg",
            MODAL_NAME: "modalName",
            MODAL_DESC: "modalDesc",
            PROFILE_BADGES: "profileBadges"
        };
        
        const RELAY_URLS = [
            "wss://relay.damus.io",
            "wss://nos.lol",
            "wss://relay.nostr.band",
            "wss://relay.snort.social",
            "wss://relay.nostrcheck.me",
            "wss://relay-jp.nostr.wirednet.jp",
            "wss://yabu.me",
            "wss://r.kojira.io"
        ];

        const NostrApp = {
            sockets: [],
            currentPubkeyHex: "",
            badgeDefs: {}, // バッジ定義のキャッシュ: `issuer:identifier` -> badge_data
            // 【重要】Kind 8イベントの受領情報を保持: `badgeKey` -> true
            receivedBadgeKeys: {}, 
            
            connectRelays() {
                // ... (変更なし)
                RELAY_URLS.forEach(url => {
                    try {
                        const socket = new WebSocket(url);
                        this.sockets.push(socket);

                        socket.onopen = () => console.log("Relay connected:", url);
                        socket.onclose = () => console.log("Relay disconnected:", url);
                        socket.onerror = (e) => console.error("Relay error:", url, e);
                        
                        socket.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                if (data[0] === "EVENT") this.handleEvent(data[2]);
                                if (data[0] === "EOSE") console.log(`EOSE received from ${url} for sub ${data[1]}`);
                            } catch (e) {
                                console.error("Error parsing or handling message:", e);
                            }
                        };
                    } catch (e) {
                        console.error(`Failed to connect to relay ${url}:`, e);
                    }
                });
            },

            sendToAllRelays(message) {
                // ... (変更なし)
                this.sockets.forEach(s => {
                    if (s.readyState === WebSocket.OPEN) {
                        s.send(JSON.stringify(message));
                    }
                });
            },

            loadAll(pubkeyHex) {
                document.getElementById(DOM_IDS.PROFILE).innerHTML = "";
                document.getElementById(DOM_IDS.RECEIVED).innerHTML = "";
                document.getElementById(DOM_IDS.ISSUED).innerHTML = "";
                
                // 【重要】状態管理変数をリセット
                this.badgeDefs = {};
                this.receivedBadgeKeys = {};

                // プロフィール (kind 0)
                this.sendToAllRelays(["REQ", "profile_req", { kinds: [0], authors: [pubkeyHex], limit: 1 }]);

                // 受け取ったバッジ (kind 8) - まず受領イベントを取得
                this.sendToAllRelays(["REQ", "received_badges_req", { kinds: [8], "#p": [pubkeyHex] }]);

                // 発行したバッジ定義 (kind 30008) - 発行バッジ用
                this.sendToAllRelays(["REQ", "issued_defs_req", { kinds: [30008], authors: [pubkeyHex] }]);
            },

            // loginWithNostr, loadFromNpub, renderProfile は変更なし...

            handleEvent(event) {
                switch (event.kind) {
                    case 0:
                        if (event.pubkey === this.currentPubkeyHex) {
                            this.renderProfile(event);
                        }
                        break;
                    case 8:
                        if (event.tags.some(t => t[0] === "p" && t[1] === this.currentPubkeyHex)) {
                            this.processReceivedBadge(event);
                        }
                        break;
                    case 30008:
                        this.processBadgeDefinition(event);
                        break;
                    default:
                        break;
                }
            },

            renderProfile(event) {
                // ... (変更なし)
                try {
                    const profile = JSON.parse(event.content);
                    const profileDiv = document.getElementById(DOM_IDS.PROFILE);
                    profileDiv.innerHTML = `
                        <div class="profile-header">
                            <img src="${profile.picture || 'https://via.placeholder.com/100'}" width="100" alt="Profile Picture">
                            <div>
                                <h2>${profile.display_name || profile.name || event.pubkey.slice(0, 8)}</h2>
                                <p><strong>npub:</strong> ${NostrTools.nip19.npubEncode(event.pubkey)}</p>
                                <p>${profile.about || '自己紹介はありません。'}</p>
                            </div>
                        </div>
                        <div class="mini-badges" id="${DOM_IDS.PROFILE_BADGES}"></div>
                    `;
                } catch (e) {
                    console.error("Error rendering profile:", e);
                }
            },
            
            /**
             * 【修正】受領したバッジ (kind 8) イベントを処理し、受領情報を保存、定義がなければリクエスト
             */
            processReceivedBadge(event) {
                const aTag = event.tags.find(t => t[0] === "a");
                if (!aTag) return;

                const parts = aTag[1].split(":");
                if (parts.length === 3 && parts[0] === "30008") {
                    const [kind, issuer, identifier] = parts;
                    const badgeKey = `${issuer}:${identifier}`;

                    // 1. 受領情報を保存 (このユーザーがこのバッジを受け取ったことを記録)
                    this.receivedBadgeKeys[badgeKey] = true; 

                    // 2. 定義がキャッシュにあれば、即座に描画
                    if (this.badgeDefs[badgeKey]) {
                        this.renderBadge(issuer, identifier, this.badgeDefs[badgeKey], false);
                    } else {
                        // 3. 定義がなければ、リクエストを送信 (既にリクエスト中かもしれないが、複数リレーに送るため気にしない)
                        const subId = `def_req_${issuer.slice(0, 8)}_${identifier.slice(0, 8)}`; 
                        this.sendToAllRelays([
                            "REQ", subId,
                            { kinds: [30008], authors: [issuer], "#d": [identifier], limit: 1 }
                        ]);
                    }
                }
            },

            /**
             * 【修正】バッジ定義 (kind 30008) イベントを処理し、キャッシュ後、必要に応じて描画
             */
            processBadgeDefinition(event) {
                const id = event.tags.find(t => t[0] === "d")?.[1];
                if (!id) return;
                
                const badgeKey = `${event.pubkey}:${id}`;

                const badgeData = {
                    name: event.tags.find(t => t[0] === "name")?.[1] || "Unnamed Badge",
                    desc: event.tags.find(t => t[0] === "description")?.[1] || "",
                    img: event.tags.find(t => t[0] === "image")?.[1] || "",
                    issuer: event.pubkey
                };
                
                // 1. 定義をキャッシュに保存
                this.badgeDefs[badgeKey] = badgeData; 

                // 2. 描画の決定
                const isIssued = event.pubkey === this.currentPubkeyHex;
                const isReceived = this.receivedBadgeKeys[badgeKey];

                if (isIssued) {
                    // 発行バッジの場合、常に描画
                    this.renderBadge(event.pubkey, id, badgeData, true);
                }
                
                if (isReceived) {
                    // 受領バッジの場合、Kind 8の記録があれば描画
                    this.renderBadge(event.pubkey, id, badgeData, false);
                }
                
                // Note: リレーへのREQは、対応するCLOSEを別途送らない限り継続されるため、
                // 実際にはアプリが閉じられるまでイベントは流れ続ける可能性があります。
                // 多くのバッジを扱う場合は、サブスクリプションの管理も必要です。
            },

            /**
             * バッジをDOMに描画する 
             */
            renderBadge(issuer, id, data, isIssued) {
                const containerId = isIssued ? DOM_IDS.ISSUED : DOM_IDS.RECEIVED;
                const container = document.getElementById(containerId);
                if (!container) return;

                // 既に描画されているかチェック (二重描画を防止)
                const badgeKey = `${issuer}:${id}`;
                const existingBadge = container.querySelector(`[data-badge-key="${badgeKey}"]`);
                if (existingBadge) return;

                const div = document.createElement("div");
                div.className = "badge";
                div.setAttribute("data-badge-key", badgeKey); 
                div.setAttribute("data-name", data.name);
                div.setAttribute("data-desc", data.desc);
                div.setAttribute("data-img", data.img);

                div.innerHTML = `
                    <img src="${data.img || 'https://via.placeholder.com/100'}" class="badge-image" alt="${data.name}">
                    <div><strong>${data.name}</strong></div>
                    <small>${data.desc.substring(0, 30)}${data.desc.length > 30 ? '...' : ''}</small>
                `;
                
                div.onclick = () => this.openModal(data.img, data.name, data.desc);
                container.appendChild(div);

                // 受け取ったバッジの場合のみ、プロフィール欄にアイコンを追加
                if (!isIssued) {
                    const profileBadgesDiv = document.getElementById(DOM_IDS.PROFILE_BADGES);
                    if (profileBadgesDiv) {
                        const mini = document.createElement("img");
                        mini.src = data.img || 'https://via.placeholder.com/32';
                        mini.title = data.name;
                        mini.onclick = (e) => {
                            e.stopPropagation(); 
                            this.openModal(data.img, data.name, data.desc);
                        };
                        profileBadgesDiv.appendChild(mini);
                    }
                }
            },
            
            // openModal, closeModal, init は変更なし...

            loginWithNostr() {
                 if (!window.nostr) {
                    alert("Nostr Login対応拡張が見つかりません (例: Alby, nos2x)");
                    return;
                }
                try {
                    const pubkey = window.nostr.getPublicKey();
                    if (pubkey.then) { // Promise対応
                        pubkey.then(p => {
                            this.currentPubkeyHex = p;
                            this.loadAll(p);
                        });
                    } else { // 同期対応
                        this.currentPubkeyHex = pubkey;
                        this.loadAll(pubkey);
                    }
                } catch (e) {
                    console.error("Nostr Login失敗:", e);
                    alert("Nostr Login失敗");
                }
            },

            loadFromNpub() {
                const npub = document.getElementById(DOM_IDS.INPUT).value.trim();
                if (!npub) return alert("npubを入力してください");
                
                try {
                    const {type, data} = NostrTools.nip19.decode(npub);
                    if (type !== "npub") throw new Error("npub形式ではありません");
                    this.currentPubkeyHex = data;
                    this.loadAll(this.currentPubkeyHex);
                } catch (e) {
                    console.error("npubのデコードに失敗しました:", e);
                    alert("npubのデコードに失敗しました");
                }
            },

            openModal(img, name, desc) {
                document.getElementById(DOM_IDS.MODAL_IMG).src = img || 'https://via.placeholder.com/200';
                document.getElementById(DOM_IDS.MODAL_NAME).textContent = name;
                document.getElementById(DOM_IDS.MODAL_DESC).textContent = desc;
                document.getElementById(DOM_IDS.MODAL).style.display = "flex";
            },

            closeModal() {
                document.getElementById(DOM_IDS.MODAL).style.display = "none";
            },
            
            init() {
                this.connectRelays();
                
                document.getElementById("loadButton").addEventListener("click", () => this.loadFromNpub());
                document.getElementById("nostrLoginButton").addEventListener("click", () => this.loginWithNostr());
                document.getElementById(DOM_IDS.INPUT).addEventListener("keypress", (e) => {
                    if (e.key === 'Enter') this.loadFromNpub();
                });
            }
        };

        NostrApp.init();
    </script>
</body>
</html>
